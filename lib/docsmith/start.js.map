{"version":3,"sources":["../../src/docsmith/start.js"],"names":["debug","require","realPath","realpathSync","path","fork","chalk","metalsmith","settings","pad","string","char","length","repeat","start","workspace","config","link","source","watch","dbg","baseurl","mapping","workspaces","Object","keys","repository","join","process","env","HOME","base_toolkit","console","log","grey","description","instance","forEach","idx","destination","metadata","site","packages","plugins","livereload","paths","document_root","port","verbose","redirects","err","exit","message","error","red","module","exports","run"],"mappings":"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","file":"start.js","sourcesContent":["const debug = require('debug')('docsmith:start');\n// const fs = require('fs-extra');\nconst realPath = require('fs').realpathSync;\n// const read = require('fs').readFileSync;\nconst path = require('path');\n// var npmi = require('npmi');\n// const yaml = require('js-yaml').safeLoad;\nconst fork = require('child_process').fork;\nconst chalk = require('chalk');\nrequire('longjohn');\n\nconst metalsmith = require('./utils/metalsmith');\n\nconst settings = require('./utils/settings');\n\nconst pad = (string, char, length) => string + char.repeat(length - string.length);\n\nfunction start({ workspace, config, link = false, source, watch = false, dbg = false, baseurl, mapping }) {\n  debug('link', link);\n  debug('source', source);\n  debug('baseurl', baseurl);\n  debug('settings.config', settings.config);\n\n  // TODO: hardwired for now.\n  const workspaces = workspace ? ['@safetag/' + workspace] : Object.keys(settings.config.workspace);\n\n  const repository = path.join(process.env.HOME, '.content');\n  const base_toolkit = realPath(path.join(repository, 'packages', 'safetag-toolkit'));\n\n  console.log(\n    '\\n' +\n      '\\n' +\n      chalk.grey('============================================================================') +\n      '\\n' +\n      chalk.grey('===========') +\n      '            ' +\n      pad((settings.description || settings.instance) + ' Starting', ' ', 42) +\n      chalk.grey('===========') +\n      '\\n' +\n      chalk.grey('============================================================================') +\n      '\\n' +\n      '\\n'\n  );\n\n  workspaces.forEach(function(workspace, idx) {\n    console.log('>> Starting workspace: ', path.join(base_toolkit, config.workspace[workspace].start));\n\n    //TODO: Make watch more targeted.\n    //TODO: Maybe factor out webserver.\n\n    metalsmith(\n      path.join(base_toolkit, config.workspace[workspace].start),\n      {\n        ...(source ? { source } : null),\n        dbg,\n        destination: path.join(repository, 'build', workspace),\n        metadata: {\n          ...config.workspace[workspace].metadata,\n          site: { baseurl },\n          packages: { ...mapping }\n        },\n        plugins: watch\n          ? [\n              {\n                'metalsmith-watch': {\n                  livereload: 35730 + idx,\n                  paths: {\n                    '${source}/**/*': '**/*.md',\n                    'code/assets/**/*': '**/*.md',\n                    'code/templates/**/*': '**/*.md'\n                  }\n                }\n              },\n              {\n                'metalsmith-serve': {\n                  document_root: '/Users/jun/.content/build',\n                  port: 8081 + idx,\n                  verbose: true,\n                  // http_error_files: {\n                  //   '404': '/404.html'\n                  // },\n                  redirects: {\n                    '/': workspace,\n                    '/searchMeta.json': '/' + workspace + '/searchMeta.json',\n                    '/searchIndex.json': '/' + workspace + '/searchIndex.json',\n                    '/debug-ui/data.json': '/' + workspace + '/debug-ui/data.json'\n                    // '/old_url.php?lang=en': '/en/new_url/'\n                  }\n                }\n              }\n            ]\n          : []\n      },\n      err => {\n        if (err) {\n          return exit('Error deploying' + workspace, err);\n        }\n        debug('>> Finished. ');\n      }\n    );\n  });\n}\n\nconst exit = (message, error) => {\n  {\n    console.log(chalk.red('\\n' + message + '\\n'));\n    if (error) console.log('error', error);\n    console.log(\n      chalk.grey('\\n==================================================================\\n\\n') +\n        chalk.red(\n          'Please alert the developer by submitting an issue \\nat https://github.com/contentascode/safetag/issues and copy the whole output of the command above.\\n\\nApologies for the inconvenience!\\n'\n        )\n    );\n    process.exit(1);\n  }\n};\n\nmodule.exports.run = start;\n"]}