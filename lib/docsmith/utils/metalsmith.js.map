{"version":3,"sources":["../../../src/docsmith/utils/metalsmith.js"],"names":["debug","require","chalk","resolve","exists","existsSync","read","readFileSync","basename","extname","dirname","format","yaml","safeLoad","async","fs","path","_","absolute","unyield","Metalsmith","debugui","module","exports","config","overrides","callback","name","dir","process","cwd","json","forEach","ext","conf","root","base","e","fatal","Error","replace","metalsmith","source","destination","concurrency","metadata","clean","frontmatter","ignore","plugins","dbg","patch","perf","merge","undefined","concat","eachSeries","normalize","plugin","cb","opts","mod","local","npm","join","use","message","stack","err","build","log","msg","console","error","red","gray","obj","Array","ret","key","push"],"mappings":";;AAAA;AACA;AACA;AACA;;AAEA,IAAMA,QAAQC,QAAQ,OAAR,EAAiB,qBAAjB,CAAd;AACA,IAAMC,QAAQD,QAAQ,OAAR,CAAd;AACA,IAAME,UAAUF,QAAQ,MAAR,EAAgBE,OAAhC;AACA,IAAMC,SAASH,QAAQ,IAAR,EAAcI,UAA7B;AACA,IAAMC,OAAOL,QAAQ,IAAR,EAAcM,YAA3B;AACA,IAAMC,WAAWP,QAAQ,MAAR,EAAgBO,QAAjC;AACA,IAAMC,UAAUR,QAAQ,MAAR,EAAgBQ,OAAhC;AACA,IAAMC,UAAUT,QAAQ,MAAR,EAAgBS,OAAhC;AACA,IAAMC,SAASV,QAAQ,MAAR,EAAgBU,MAA/B;AACA,IAAMC,OAAOX,QAAQ,SAAR,EAAmBY,QAAhC;AACA,IAAMC,QAAQb,QAAQ,OAAR,CAAd;AACA,IAAMc,KAAKd,QAAQ,aAAR,CAAX;AACA,IAAMe,OAAOf,QAAQ,MAAR,CAAb;AACA,IAAMgB,IAAIhB,QAAQ,QAAR,CAAV;;AAEA,IAAMiB,WAAWjB,QAAQ,UAAR,CAAjB;AACA,IAAMkB,UAAUlB,QAAQ,SAAR,CAAhB;AACA,IAAMmB,aAAanB,QAAQ,YAAR,CAAnB;AACA,IAAMoB,UAAUpB,QAAQ,qBAAR,CAAhB;;AAEA;AACAqB,OAAOC,OAAP,GAAiB,UAASC,MAAT,EAAiBC,SAAjB,EAA4BC,QAA5B,EAAsC;AACrD,MAAMC,OAAOnB,SAASgB,MAAT,EAAiBf,QAAQe,MAAR,CAAjB,CAAb;AACAxB,QAAM,MAAN,EAAc2B,IAAd;AACA,MAAMC,MAAMzB,QAAQ0B,QAAQC,GAAR,EAAR,EAAuBpB,QAAQc,MAAR,CAAvB,CAAZ;AACAxB,QAAM,KAAN,EAAa4B,GAAb;;AAEA,MAAIG,aAAJ;;AAEA,GAAC,OAAD,EAAU,MAAV,EAAkB,OAAlB,EAA2BC,OAA3B,CAAmC,UAASC,GAAT,EAAc;AAC/C,QAAMC,OAAOvB,OAAO,EAAEwB,MAAM,GAAR,EAAaP,GAAb,EAAkBQ,MAAMT,OAAOM,GAA/B,EAAP,CAAb;AACA,QAAMjB,OAAOb,QAAQyB,GAAR,EAAalB,QAAQc,MAAR,CAAb,EAA8BU,IAA9B,CAAb;;AAEA,QAAI,CAAC9B,OAAOY,IAAP,CAAD,IAAiBe,IAArB,EAA2B;AAC3B,QAAI;AACF,UAAIE,QAAQ,OAAZ,EAAqB;AACnBF,eAAO9B,QAAQe,IAAR,CAAP;AACD,OAFD,MAEO,IAAIiB,QAAQ,MAAR,IAAkBA,QAAQ,OAA9B,EAAuC;AAC5CF,eAAOnB,KAAKN,KAAKU,IAAL,EAAW,MAAX,CAAL,CAAP;AACD;AACF,KAND,CAME,OAAOqB,CAAP,EAAU;AACV,aAAOX,SAASY,MAAM,mBAAmBJ,IAAnB,GAA0B,gBAAhC,EAAkD,IAAIK,KAAJ,CAAU,eAAV,EAA2BL,IAA3B,CAAlD,CAAT,CAAP;AACD;AACF,GAdD;;AAgBA,MAAI,CAACH,IAAL,EACE,OAAOL,SACLY,MACE,sBAAsBd,OAAOgB,OAAP,CAAe,OAAf,EAAwB,EAAxB,CAAtB,GAAoD,0CADtD,EAEE,IAAID,KAAJ,CAAU,mCAAV,CAFF,CADK,CAAP;;AAOF,MAAME,aAAa,IAAIrB,UAAJ,CAAeQ,GAAf,CAAnB;;AAhCqD,0BA4CjDH,SA5CiD,CAmCnDiB,MAnCmD;AAAA,MAmCnDA,MAnCmD,qCAmC1CX,KAAKW,MAnCqC;AAAA,8BA4CjDjB,SA5CiD,CAoCnDkB,WApCmD;AAAA,MAoCnDA,WApCmD,yCAoCrCZ,KAAKY,WApCgC;AAAA,8BA4CjDlB,SA5CiD,CAqCnDmB,WArCmD;AAAA,MAqCnDA,WArCmD,yCAqCrCb,KAAKa,WArCgC;AAAA,4BA4CjDnB,SA5CiD,CAsCnDoB,QAtCmD;AAAA,MAsCnDA,QAtCmD,uCAsCxCd,KAAKc,QAtCmC;AAAA,yBA4CjDpB,SA5CiD,CAuCnDqB,KAvCmD;AAAA,MAuCnDA,KAvCmD,oCAuC3Cf,KAAKe,KAvCsC;AAAA,8BA4CjDrB,SA5CiD,CAwCnDsB,WAxCmD;AAAA,MAwCnDA,WAxCmD,yCAwCrChB,KAAKgB,WAxCgC;AAAA,0BA4CjDtB,SA5CiD,CAyCnDuB,MAzCmD;AAAA,MAyCnDA,MAzCmD,qCAyC1CjB,KAAKiB,MAzCqC;AAAA,2BA4CjDvB,SA5CiD,CA0CnDwB,OA1CmD;AAAA,MA0CnDA,OA1CmD,sCA0CzC,EA1CyC;AAAA,MA2CnDC,GA3CmD,GA4CjDzB,SA5CiD,CA2CnDyB,GA3CmD;;;AA8CrD,MAAIA,GAAJ,EAAS7B,QAAQ8B,KAAR,CAAcV,UAAd,EAA0B,EAAEW,MAAM,IAAR,EAA1B;;AAET,MAAIV,MAAJ,EAAYD,WAAWC,MAAX,CAAkBA,MAAlB;AACZ,MAAIC,WAAJ,EAAiBF,WAAWE,WAAX,CAAuBA,WAAvB;AACjB,MAAIC,WAAJ,EAAiBH,WAAWG,WAAX,CAAuBA,WAAvB;AACjB,MAAIC,QAAJ,EAAcJ,WAAWI,QAAX,CAAoBd,KAAKc,QAAL,GAAgB5B,EAAEoC,KAAF,CAAQtB,KAAKc,QAAb,EAAuBA,QAAvB,CAAhB,GAAmDA,QAAvE;;AAEd,MAAIC,UAAUQ,SAAd,EAAyBb,WAAWK,KAAX,CAAiBA,KAAjB;AACzB,MAAIC,gBAAgBO,SAApB,EAA+Bb,WAAWM,WAAX,CAAuBA,WAAvB;AAC/B,MAAIC,WAAWM,SAAf,EAA0Bb,WAAWO,MAAX,CAAkBA,MAAlB;;AAE1BhD,QAAM,cAAN,EAAsB+B,KAAKkB,OAA3B;AACAjD,QAAM,SAAN,EAAiBiD,OAAjB;AACAlB,OAAKkB,OAAL,GAAelB,KAAKkB,OAAL,CAAaM,MAAb,CAAoBN,OAApB,CAAf;;AAEA;;;;AAIAnC,QAAM0C,UAAN,CACEC,UAAU1B,KAAKkB,OAAf,CADF,EAEE,UAASS,MAAT,EAAiBC,EAAjB,EAAqB;AACnB,SAAK,IAAMhC,KAAX,IAAmB+B,MAAnB,EAA2B;AACzB,UAAME,OAAOF,OAAO/B,KAAP,CAAb;AACA,UAAIkC,YAAJ;;AAEA,UAAI;AACF,YAAMC,QAAQ3D,QAAQyB,GAAR,EAAaD,KAAb,CAAd;AACA,YAAMoC,MAAM5D,QAAQyB,GAAR,EAAa,cAAb,EAA6BD,KAA7B,CAAZ;AACA3B,cAAM,8BAAN,EAAsCgB,KAAKgD,IAAL,CAAUpC,GAAV,EAAe,cAAf,EAA+BD,KAA/B,CAAtC;AACA;AACA,YAAIvB,OAAO0D,KAAP,KAAiB1D,OAAO0D,QAAQ,KAAf,CAArB,EAA4C;AAC1CD,gBAAM5D,QAAQ6D,KAAR,CAAN;AACD,SAFD,MAEO,IAAI1D,OAAO2D,GAAP,CAAJ,EAAiB;AACtBF,gBAAM5D,QAAQ8D,GAAR,CAAN;AACD,SAFM,MAEA;AACLF,gBAAM5D,QAAQ0B,KAAR,CAAN;AACD;AACF,OAZD,CAYE,OAAOU,CAAP,EAAU;AACV,eAAOsB,GAAGrB,MAAM,+BAA+BX,KAA/B,GAAsC,IAA5C,EAAkD,IAAIY,KAAJ,CAAU,uBAAV,CAAlD,CAAH,CAAP;AACD;;AAED,UAAI;AACFE,mBAAWwB,GAAX,CAAeJ,IAAID,IAAJ,CAAf;AACAD;AACD,OAHD,CAGE,OAAOtB,CAAP,EAAU;AACV,eAAOsB,GAAGrB,MAAM,yBAAyBX,KAAzB,GAAgC,MAAtC,EAA8CU,EAAE6B,OAAF,GAAY,MAAZ,GAAqB7B,EAAE8B,KAArE,CAAH,CAAP;AACD;AACF;AACF,GA9BH,EA+BE,eAAO;AACL,QAAIC,GAAJ,EAAS,OAAO1C,SAAS0C,GAAT,CAAP;AACT;AACD,GAlCH;;AAqCA;;;;AAIA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;;;;AAIA3B,aAAW4B,KAAX,CAAiB,UAASD,GAAT,EAAc;AAC7B,QAAIA,GAAJ,EAAS,OAAO1C,SAASY,MAAM8B,IAAIF,OAAV,EAAmBE,GAAnB,CAAT,CAAP;AACTE,QAAI,2BAAJ;;AAEA,WAAO5C,UAAP;AACD,GALD;;AAOA;;;;;;;AAOA,WAASY,KAAT,CAAeiC,GAAf,EAAoBH,GAApB,EAAyB;AACvBI,YAAQC,KAAR;AACAD,YAAQC,KAAR,CAAcvE,MAAMwE,GAAN,CAAU,cAAV,IAA4BxE,MAAMyE,IAAN,CAAW,KAAX,CAA5B,GAAgDJ,GAA9D;AACA,QAAIH,IAAID,KAAR,EAAe;AACbK,cAAQC,KAAR;AACAD,cAAQC,KAAR,CAAcvE,MAAMyE,IAAN,CAAWP,IAAID,KAAf,CAAd;AACD;AACDK,YAAQC,KAAR;AACA,WAAOL,GAAP;AACD;;AAED;;;;;;AAMA,WAASE,GAAT,CAAaJ,OAAb,EAAsB;AACpBM,YAAQF,GAAR;AACAE,YAAQF,GAAR,CAAYpE,MAAMyE,IAAN,CAAW,iBAAX,IAAgCT,OAA5C;AACAM,YAAQF,GAAR;AACD;;AAED;;;;;;;AAOA,WAASb,SAAT,CAAmBmB,GAAnB,EAAwB;AACtB,QAAIA,eAAeC,KAAnB,EAA0B,OAAOD,GAAP;AAC1B,QAAME,MAAM,EAAZ;;AAEA,SAAK,IAAMC,GAAX,IAAkBH,GAAlB,EAAuB;AACrB,UAAMlB,SAAS,EAAf;AACAA,aAAOqB,GAAP,IAAcH,IAAIG,GAAJ,CAAd;AACAD,UAAIE,IAAJ,CAAStB,MAAT;AACD;;AAED,WAAOoB,GAAP;AACD;AACF,CAnLD","file":"metalsmith.js","sourcesContent":["// Extracted from metalsmith library to handle config loading\n// Modified to:\n//  - support config file overrides.\n//  - process files to symlinks instead of building\n\nconst debug = require('debug')('docsmith:metalsmith');\nconst chalk = require('chalk');\nconst resolve = require('path').resolve;\nconst exists = require('fs').existsSync;\nconst read = require('fs').readFileSync;\nconst basename = require('path').basename;\nconst extname = require('path').extname;\nconst dirname = require('path').dirname;\nconst format = require('path').format;\nconst yaml = require('js-yaml').safeLoad;\nconst async = require('async');\nconst fs = require('co-fs-extra');\nconst path = require('path');\nconst _ = require('lodash');\n\nconst absolute = require('absolute');\nconst unyield = require('unyield');\nconst Metalsmith = require('metalsmith');\nconst debugui = require('metalsmith-debug-ui');\n\n// Pass config file path, config overrides and make async.\nmodule.exports = function(config, overrides, callback) {\n  const name = basename(config, extname(config));\n  debug('name', name);\n  const dir = resolve(process.cwd(), dirname(config));\n  debug('dir', dir);\n\n  let json;\n\n  ['.json', '.yml', '.yaml'].forEach(function(ext) {\n    const conf = format({ root: '/', dir, base: name + ext });\n    const path = resolve(dir, dirname(config), conf);\n\n    if (!exists(path) || json) return;\n    try {\n      if (ext === '.json') {\n        json = require(path);\n      } else if (ext === '.yml' || ext === '.yaml') {\n        json = yaml(read(path, 'utf8'));\n      }\n    } catch (e) {\n      return callback(fatal('it seems like ' + conf + ' is malformed.', new Error('Error in conf', conf)));\n    }\n  });\n\n  if (!json)\n    return callback(\n      fatal(\n        'could not find a ' + config.replace('.json', '') + '.json / .yml / .yaml configuration file.',\n        new Error('Could not find configuration file')\n      )\n    );\n\n  const metalsmith = new Metalsmith(dir);\n\n  const {\n    source = json.source,\n    destination = json.destination,\n    concurrency = json.concurrency,\n    metadata = json.metadata,\n    clean = json.clean,\n    frontmatter = json.frontmatter,\n    ignore = json.ignore,\n    plugins = [],\n    dbg\n  } = overrides;\n\n  if (dbg) debugui.patch(metalsmith, { perf: true });\n\n  if (source) metalsmith.source(source);\n  if (destination) metalsmith.destination(destination);\n  if (concurrency) metalsmith.concurrency(concurrency);\n  if (metadata) metalsmith.metadata(json.metadata ? _.merge(json.metadata, metadata) : metadata);\n\n  if (clean !== undefined) metalsmith.clean(clean);\n  if (frontmatter !== undefined) metalsmith.frontmatter(frontmatter);\n  if (ignore !== undefined) metalsmith.ignore(ignore);\n\n  debug('json.plugins', json.plugins);\n  debug('plugins', plugins);\n  json.plugins = json.plugins.concat(plugins);\n\n  /**\n   * Plugins.\n   */\n\n  async.eachSeries(\n    normalize(json.plugins),\n    function(plugin, cb) {\n      for (const name in plugin) {\n        const opts = plugin[name];\n        let mod;\n\n        try {\n          const local = resolve(dir, name);\n          const npm = resolve(dir, 'node_modules', name);\n          debug('resolving npm package with :', path.join(dir, 'node_modules', name));\n          // debug('ls ' + dir, fs.readdirSync(dir).join('\\n'));\n          if (exists(local) || exists(local + '.js')) {\n            mod = require(local);\n          } else if (exists(npm)) {\n            mod = require(npm);\n          } else {\n            mod = require(name);\n          }\n        } catch (e) {\n          return cb(fatal('failed to require plugin \"' + name + '\".', new Error('Could not find plugin')));\n        }\n\n        try {\n          metalsmith.use(mod(opts));\n          cb();\n        } catch (e) {\n          return cb(fatal('error using plugin \"' + name + '\"...', e.message + '\\n\\n' + e.stack));\n        }\n      }\n    },\n    err => {\n      if (err) return callback(err);\n      return;\n    }\n  );\n\n  /**\n   * TODO: Monkey patch to create symlinked build?\n   */\n\n  // metalsmith.writeFile = unyield(function*(file, data) {\n  //   const dest = this.destination();\n  //   if (!absolute(file)) file = path.resolve(dest, file);\n  //\n  //   try {\n  //     yield fs.outputFile(file, data.contents);\n  //     if (data.mode) yield fs.chmod(file, data.mode);\n  //   } catch (e) {\n  //     e.message = 'Failed to write the file at: ' + file + '\\n\\n' + e.message;\n  //     throw e;\n  //   }\n  // });\n\n  /**\n   * Build.\n   */\n\n  metalsmith.build(function(err) {\n    if (err) return callback(fatal(err.message, err));\n    log('successfully built files.');\n\n    return callback();\n  });\n\n  /**\n   * Log an error and then exit the process.\n   *\n   * @param {String} msg\n   * @param {String} [stack]  Optional stack trace to print.\n   */\n\n  function fatal(msg, err) {\n    console.error();\n    console.error(chalk.red('  Metalsmith') + chalk.gray(' · ') + msg);\n    if (err.stack) {\n      console.error();\n      console.error(chalk.gray(err.stack));\n    }\n    console.error();\n    return err;\n  }\n\n  /**\n   * Log a `message`.\n   *\n   * @param {String} message\n   */\n\n  function log(message) {\n    console.log();\n    console.log(chalk.gray('  Metalsmith · ') + message);\n    console.log();\n  }\n\n  /**\n   * Normalize an `obj` of plugins.\n   *\n   * @param {Array or Object} obj\n   * @return {Array}\n   */\n\n  function normalize(obj) {\n    if (obj instanceof Array) return obj;\n    const ret = [];\n\n    for (const key in obj) {\n      const plugin = {};\n      plugin[key] = obj[key];\n      ret.push(plugin);\n    }\n\n    return ret;\n  }\n};\n"]}