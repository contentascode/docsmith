{"version":3,"sources":["../src/docsmith-build.js"],"names":["program","require","settings","spawn","path","fs","component","description","option","arguments","action","comp","parse","process","argv","console","log","generate","config","build","fileExists","join","cwd","exit","metalsmith","destination","metadata","formatDate","date","format","serve","watch","redirects","Object","assign","publish","baseurl","plugins","push","document_root","http_error_files","paths","reload","livereload","customHTML","validate","writeFile","JSON","stringify","err","jekyll","concat","env","stdio","filePath","statSync","isFile"],"mappings":"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","file":"docsmith-build.js","sourcesContent":["\n\n/**\n * Module dependencies.\n */\n\nconst program = require('commander');\nconst settings = require('./docsmith/settings').settings;\nconst spawn = require('child_process').spawn;\nconst path = require('path');\nconst fs = require('fs');\n\nlet component;\n\nprogram\n  .description('Builds or serves the current content')\n  .option('-s, --serve', 'Serves')\n  .option('-w, --watch', 'Serves and watches')\n  .option('-r, --reload', 'Live reload')\n  .option('-v, --validate', 'Validate links')\n  .option('-c, --config <config>', 'Specify configuration file')\n  .option('-d, --destination <directory>', 'Specify build destination')\n  .arguments('[component] [options]')\n  .action(function(comp) {\n    component = comp;\n  })\n  .parse(process.argv);\n\nif (component) console.log('Ignoring option component', component);\n\nif (!settings.generate) {\n  console.log('You do not have a static site generator installed.');\n}\n\nlet config;\n\nif (settings.build && settings.build == 'grunt') {\n  if (!fileExists(path.join(process.cwd(), 'Gruntfile.js'))) {\n    console.log('Could not find a metalsmith configuration file.');\n    process.exit(1);\n  }\n  // const grunt = spawn('grunt', [], { env: process.env, stdio: 'inherit' });\n} else if (settings.generate.metalsmith) {\n  if (program.config && fileExists(path.join(process.cwd(), program.config))) {\n    config = require(path.join(process.cwd(), program.config));\n  } else if (fileExists(path.join(process.cwd(), 'metalsmith.json'))) {\n    config = require(path.join(process.cwd(), 'metalsmith.json'));\n  } else {\n    console.log('Could not find a metalsmith configuration file.');\n    process.exit(1);\n  }\n\n  if (program.destination) {\n    config.destination = program.destination;\n  }\n\n  //  var metalsmith = spawn('metalsmith', [''], { env: process.env, stdio: \"inherit\"});\n\n  // provide a formatting function for use in templates\n  config.metadata.formatDate = function(date, format) {\n    return require('moment')(date).format(format || 'MMMM Do, YYYY');\n  };\n  // only enable live-reloading when requested\n  if (program.serve || program.watch) {\n    const redirects = Object.assign(\n      {\n        '/': settings.publish.baseurl + '/'\n      },\n      settings.publish.redirects\n    );\n\n    config.plugins.push({\n      'metalsmith-serve': {\n        document_root: '_site',\n        redirects,\n        http_error_files: {\n          '404': settings.publish.baseurl + '/404.html'\n        }\n      }\n    });\n  }\n\n  if (program.watch) {\n    const watch = {\n      'metalsmith-watch': {\n        paths: {\n          '${source}/**/*.md': true,\n          '_layouts/**': '**/*.md',\n          '_includes/**': '**/*.md'\n        }\n      }\n    };\n    if (program.reload) {\n      watch['metalsmith-watch'].livereload = 35729;\n      config.metadata.customHTML = '<script src=\"http://localhost:35729/livereload.js?snipver=1\"></script>';\n    }\n    config.plugins.push(watch);\n  }\n  // if (program.watch && program.reload) {\n  //   config.plugins.push( { 'metalsmith-watch' : { livereload: 35729 } } );\n  //   config.metadata.customHTML = '<script src=\"http://localhost:35729/livereload.js?snipver=1\"></script>';\n  // }\n  if (program.validate) {\n    config.plugins.push({ 'metalsmith-broken-link-checker': true });\n  }\n  // config.plugins.find( x => { for (k in x) { return (k == 'metalsmith-ignore') } } )['metalsmith-ignore'].push(\"metalsmith.tmp.json\");\n  // Swallow the --watch option\n  process.argv = [];\n\n  fs.writeFile('metalsmith.tmp.json', JSON.stringify(config, null, 2), 'utf8', function(err) {\n    if (err) {\n      console.log(err);\n      process.exit(1);\n    }\n    process.argv.push('/usr/local/bin/node', '/usr/local/bin/content-build', '--config', 'metalsmith.tmp.json');\n    require('metalsmith/bin/metalsmith');\n  });\n} else if (settings.generate.jekyll) {\n  config = program.config ? ['--config', program.config] : [];\n  spawn('bundle', ['exec', 'jekyll', 'build'].concat(config), { env: process.env, stdio: 'inherit' });\n}\n\nfunction fileExists(filePath) {\n  try {\n    return fs.statSync(filePath).isFile();\n  } catch (err) {\n    return false;\n  }\n}\n"]}